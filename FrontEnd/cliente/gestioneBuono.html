<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <title>Gestione Buono</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script>
        let polizze = [];

        function controllaAccessoCliente() {
            const utente = JSON.parse(localStorage.getItem("utente"));

            if (!utente || utente.privilegio !== "cliente") {
                alert("Accesso negato. Effettua il login come cliente.");
                window.location.href = "../login.html";
            }
        }

        function caricaPolizze() {
            fetch("http://localhost:8080/visualizza/polizza")
                .then(res => res.json())
                .then(data => {
                    polizze = data;
                    const select = document.getElementById("polizzaBuono");
                    select.innerHTML = ""; // svuota prima
                    if (polizze.length === 0) {
                        select.innerHTML = "<option value=''>Nessuna polizza disponibile</option>";
                        return;
                    }
                    polizze.forEach(p => {
                        const option = document.createElement("option");
                        option.value = p.id;
                        option.textContent = p.nome || `Polizza ${p.id}`;
                        select.appendChild(option);
                    });
                })
                .catch(() => {
                    const select = document.getElementById("polizzaBuono");
                    select.innerHTML = "<option value=''>Errore nel caricamento polizze</option>";
                });
        }

        function inserisciBuono() {
            const data = document.getElementById("dataBuono").value.trim();
            const polizzaId = document.getElementById("polizzaBuono").value;
            const peso = document.getElementById("pesoBuono").value.trim();

            if (!data || !polizzaId || !peso || isNaN(peso)) {
                mostraOutput("‚ö†Ô∏è Inserisci tutti i campi correttamente (peso deve essere un numero)", "warning");
                return;
            }

            const url = `http://localhost:8080/inserisci/buono?data=${encodeURIComponent(data)}&polizza=${encodeURIComponent(polizzaId)}&peso=${peso}`;
            fetch(url)
                .then(res => res.text())
                .then(() => {
                    mostraOutput("‚úÖ Buono inserito.", "success");
                    // pulizia campi
                    document.getElementById("dataBuono").value = "";
                    document.getElementById("pesoBuono").value = "";
                    document.getElementById("polizzaBuono").selectedIndex = 0;
                })
                .catch(() => {
                    mostraOutput("‚ùå Errore durante l'inserimento del buono.", "danger");
                });
        }

        function visualizzaBuoni() {
            fetch("http://localhost:8080/visualizza/buono")
                .then(res => res.json())
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        mostraOutput("‚ö†Ô∏è Nessun buono trovato.", "warning");
                        return;
                    }

                    let html = `<table class="table table-striped table-bordered mt-3">
                                    <thead class="table-dark">
                                        <tr><th>ID</th><th>Data</th><th>Polizza</th><th>Peso</th></tr>
                                    </thead><tbody>`;
                    data.forEach(buono => {
                        const polizzaObj = polizze.find(p => p.id == buono.polizza?.id);
                        const polizzaNome = polizzaObj ? polizzaObj.nome || `Polizza ${polizzaObj.id}` : "N/D";

                        html += `<tr>
                                    <td>${buono.id}</td>
                                    <td>${buono.data}</td>
                                    <td>${polizzaNome}</td>
                                    <td>${buono.peso}</td>
                                </tr>`;
                    });

                    html += "</tbody></table>";
                    document.getElementById("output").innerHTML = html;
                })
                .catch(() => {
                    mostraOutput("‚ùå Errore durante la visualizzazione.", "danger");
                });
        }

        function eliminaBuono() {
            const id = document.getElementById("idElimina").value.trim();

            if (!id || isNaN(id) || parseInt(id) <= 0) {
                mostraOutput("‚ö†Ô∏è Inserisci un ID valido per eliminare un buono.", "warning");
                return;
            }

            const url = `http://localhost:8080/elimina/buono?id=${id}`;
            fetch(url)
                .then(res => res.text())
                .then(() => {
                    mostraOutput("‚úÖ Buono eliminato.", "success");
                    document.getElementById("idElimina").value = "";
                })
                .catch(() => {
                    mostraOutput("‚ùå Errore durante l'eliminazione del buono.", "danger");
                });
        }

        function tornaIndietro() {
            window.location.href = "indexCliente.html";
        }

        function mostraOutput(messaggio, tipo) {
            const output = document.getElementById("output");
            output.innerHTML = `<div class="alert alert-${tipo}" role="alert">${messaggio}</div>`;
        }

        window.onload = function () {
            controllaAccessoCliente();
            caricaPolizze();
        };
    </script>
</head>

<body class="bg-light">
    <div class="container py-4">
        <h2 class="mb-4 text-center">Gestione Buono</h2>

        <div class="card p-3 mb-4 shadow-sm">
            <h3>‚ûï Inserisci Buono</h3>
            <form onsubmit="event.preventDefault(); inserisciBuono();">
                <div class="mb-3">
                    <label for="dataBuono" class="form-label">Data</label>
                    <input type="date" id="dataBuono" class="form-control" />
                </div>
                <div class="mb-3">
                    <label for="polizzaBuono" class="form-label">Polizza</label>
                    <select id="polizzaBuono" class="form-select">
                        <option>Caricamento...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="pesoBuono" class="form-label">Peso</label>
                    <input type="number" step="0.50" min="1" id="pesoBuono" class="form-control" />
                </div>
                <button type="submit" class="btn btn-primary">Inserisci</button>
            </form>
        </div>

        <div class="text-center mb-4">
            <h3>üìã Visualizza Buoni</h3>
            <button class="btn btn-info" onclick="visualizzaBuoni()">Visualizza</button>
        </div>

        <div class="card p-3 mb-4 shadow-sm">
            <h3>üóëÔ∏è Elimina Buono</h3>
            <div class="input-group" style="max-width: 200px;">
                <input type="number" min="1" id="idElimina" class="form-control" placeholder="ID Buono" />
                <button class="btn btn-danger" onclick="eliminaBuono()">Elimina</button>
            </div>
        </div>

        <div class="text-center mb-4">
            <button class="btn btn-secondary" onclick="tornaIndietro()">Torna Indietro</button>
        </div>

        <h3>Output:</h3>
        <div id="output"></div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
